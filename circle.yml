machine:
  timezone: UTC
  environment:
    SBT_OPTS: "-Dfile.encoding=UTF8 -Xms512M -Xmx1024M -Xss1M -XX:+CMSClassUnloadingEnabled -XX:+UseCompressedOops -Dbuild.tag=\"$CIRCLE_TAG\" -Dbuild.number=$CIRCLE_BUILD_NUM -Dbuild.vcs.number=$CIRCLE_SHA1"
    JEST_JUNIT_OUTPUT: ${CIRCLE_TEST_REPORTS}/jest/frontend-junit.xml
  java:
    version: oraclejdk8
  node:
    version: 8.1.3

dependencies:
  # Install specific version of sbt - See https://circleci.com/docs/language-scala/
  pre:
    - wget -q https://dl.bintray.com/sbt/debian/sbt-0.13.15.deb
    - sudo dpkg -i sbt-0.13.15.deb
    - sudo apt-get install rpm librpmbuild3
    #install jython so we can pull in pip modules, and get the default python module set
    - curl http://search.maven.org/remotecontent?filepath=org/python/jython-installer/2.7.0/jython-installer-2.7.0.jar > jython-installer-2.7.0.jar
    - if [ ! -d ~/jython ]; then java -jar jython-installer-2.7.0.jar -s -d ~/jython -t standard -e doc; fi
  # Cache resolution-cache and streams for faster dependency resolution in sbt
  # Cache node_modules and bower_components for faster client-side build
  cache_directories:
    - ~/.sbt
    - ~/jython
    - frontend/node_modules

  override:
    - cd frontend; npm install
    - cd frontend; npm run build
    - sbt test:compile
    - ~/jython/bin/pip install -r postrun/requirements.txt
    - mkdir -p postrun/lib/python
    - cp -a ~/jython/Lib postrun/lib/python

database:
  pre:
    - sudo -u postgres createuser projectlocker
    - sudo -u postgres createdb projectlocker -O projectlocker
    - sudo -u postgres createdb projectlocker_test -O projectlocker

test:
  override:
    - sbt test
    - cd frontend; npm run test
    - scripts/check_evolutions.sh
    - PYTHONPATH=postrun/scripts ~/jython/bin/nosetests -w postrun/tests

deployment:
  make_rpm:
    branch: /.*/
    commands:
      - cd frontend; npm run compile
      - sbt rpm:packageBin
      - for x in `ls target/rpm/RPMS/noarch/projectlocker*.rpm`; do bash ./upload_to_s3.sh "$x"; done